# Plan: Book Profile Analysis & Extraction Consistency (plan-0006)

**Status:** Completed
**Date:** 2026-02-24

## Overview

The c-programming EPUB (a 44MB technical textbook with 2,536 images and 14,373 cross-references) exposes several extraction weaknesses:

1. **SVG cover images** become massive `data:image/svg+xml;base64,...` blobs instead of proper `![alt](path)` references — the SVG just wraps a single `<image xlink:href="cover.jpeg"/>` that should be unwrapped
2. **Anchor preservation is too narrow** — only `<a>`, `<p>`, `<h1-6>`, `<section>`, `<article>`, `<li>` IDs are preserved. Other elements (`<div>`, `<span>`, `<blockquote>`, `<tt>`, etc.) are silently stripped
3. **Empty alt text** — many images extract as `![](path)` from `alt=""` source attributes, hurting readability
4. **No book classification** — there's no analysis step to characterize an EPUB's structure before extraction
5. **Link validation gaps** — heading-generated anchors (e.g., `## Foo` -> `#foo`) aren't checked as valid targets

## Implementation Sequence

### 1. New module: `src/extract/profile.rs`

Analyze `EpubBook` structure before extraction. Single function `analyze_book(book) -> BookProfile`.

```rust
pub enum BookGenre { Fiction, Technical, Reference, Illustrated, Minimal }

pub struct BookProfile {
    pub genre: BookGenre,
    pub spine_count: usize,
    pub image_count: usize,
    pub cross_reference_count: usize,
    pub has_image_gallery: bool,
    pub has_svg_cover: bool,
    pub empty_alt_count: usize,
}
```

Classification heuristic:
- `image_count > 100 && cross_refs > 500` → Technical
- `spine_count > 100` → Reference
- `image_count > 10 && cross_refs < 10` → Illustrated
- `spine_count < 15 && image_count < 5` → Minimal
- else → Fiction

Called in `extract_book()` after `detect_opf_dir()`. Profile written to `metadata.yml` under the `epx` key. Informational only — does not branch extraction logic.

### 2. SVG cover unwrapping — `src/extract/html_to_md.rs`

Add preprocessing step in `preprocess_xhtml()` between head-stripping and anchor preservation:

Replace `<svg>...<image xlink:href="X"/>...</svg>` with `<img src="X" alt="Cover image"/>` only when SVG contains a single `<image>` and no drawing elements (`<rect>`, `<circle>`, `<path>`, `<text>`, `<line>`).

### 3. Universal anchor preservation — `src/extract/html_to_md.rs`

Replace the Step 2 element-specific regex:

```rust
// BEFORE: only p, h1-6, section, article, li
Regex::new(r#"(<(?:p|h[1-6]|section|article|li)\b)([^>]*?)\sid="([^"]+)"([^>]*>)"#)

// AFTER: any element except <a> (already handled in Steps 1a/1b)
Regex::new(r#"(<(?!a\b)(\w+)\b)([^>]*?)\sid="([^"]+)"([^>]*>)"#)
```

### 4. Empty alt-text fallback — `src/extract/html_to_md.rs`

Add preprocessing step after SVG unwrapping. Two regex passes:
1. `<img ... alt="" ...>` → replace `alt=""` with `alt="derived"`
2. `<img ...>` missing `alt` entirely → inject `alt="derived"`

Helper `derive_alt_from_attrs()`: extract filename from `src`, strip extension, humanize.

### 5. Link validation improvements — `src/extract/mod.rs`

Refactor `validate_extraction_links()`:
- Return `LinkValidationReport` struct instead of `Vec<String>`
- Add heading-slug anchor collection
- Update `extract_book()` to use the report struct

### 6. Profile in metadata — `src/extract/frontmatter.rs`

Change `from_epub_metadata()` to accept `Option<&BookProfile>`. Serialize profile fields to `epx` HashMap in `metadata.yml`.

## Files to modify

| File | Change |
|------|--------|
| `src/extract/profile.rs` | **New** — `BookProfile`, `BookGenre`, `analyze_book()` |
| `src/extract/mod.rs` | Add `pub mod profile;`, call `analyze_book()`, pass profile to frontmatter, update link validation return type |
| `src/extract/html_to_md.rs` | SVG unwrapping, universal anchor regex, alt-text fallback, `derive_alt_from_attrs()` |
| `src/extract/frontmatter.rs` | Add `profile` param to `from_epub_metadata()`, serialize to yaml |
| `tests/deep_regression_test.rs` | Add profile assertion test, SVG/alt-text quality checks |

## Completion Criteria

1. `cargo fmt && cargo clippy -- -D warnings && cargo test` — all pass
2. `cargo test --test deep_regression_test -- --include-ignored` — both `deep_extract_all` and `deep_roundtrip_all` pass
3. No `data:image/svg+xml;base64` in extracted markdown
4. No `![]()` (empty alt) in any extracted markdown
5. `metadata.yml` contains genre classification under `epx` key
